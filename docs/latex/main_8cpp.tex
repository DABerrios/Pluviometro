\doxysection{src/main.cpp File Reference}
\hypertarget{main_8cpp}{}\label{main_8cpp}\index{src/main.cpp@{src/main.cpp}}
{\ttfamily \#include $<$Arduino.\+h$>$}\newline
{\ttfamily \#include $<$SPI.\+h$>$}\newline
{\ttfamily \#include $<$Wire.\+h$>$}\newline
{\ttfamily \#include $<$RTClib.\+h$>$}\newline
{\ttfamily \#include $<$esp\+\_\+sleep.\+h$>$}\newline
{\ttfamily \#include $<$Async\+TCP.\+h$>$}\newline
{\ttfamily \#include $<$ESPAsync\+Web\+Server.\+h$>$}\newline
{\ttfamily \#include $<$Wi\+Fi.\+h$>$}\newline
{\ttfamily \#include $<$FS.\+h$>$}\newline
{\ttfamily \#include $<$SD.\+h$>$}\newline
{\ttfamily \#include $<$preferences.\+h$>$}\newline
{\ttfamily \#include $<$lora.\+h$>$}\newline
{\ttfamily \#include $<$main.\+h$>$}\newline
{\ttfamily \#include $<$temp\+\_\+sens.\+h$>$}\newline
{\ttfamily \#include $<$wifi\+\_\+ap\+\_\+serv.\+h$>$}\newline
{\ttfamily \#include $<$SD\+\_\+adp.\+h$>$}\newline
{\ttfamily \#include $<$air\+\_\+sens.\+h$>$}\newline
{\ttfamily \#include $<$RTC\+\_\+\+DS3231.\+h$>$}\newline
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
SPIClass \mbox{\hyperlink{main_8cpp_a986d1c8378e226e7d3f389c83d94d790}{vspi}} (VSPI)
\item 
void \mbox{\hyperlink{main_8cpp_a4fc01d736fe50cf5b977f755b675f11d}{setup}} ()
\begin{DoxyCompactList}\small\item\em Setup function for initializing the ESP32 and peripherals. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_afe461d27b9c48d5921c00d521181f12f}{loop}} ()
\begin{DoxyCompactList}\small\item\em Main loop function that handles server activity and power management. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_abef06e3b619f047a7b59887b28b33c6e}{log\+Data}} (const char \texorpdfstring{$\ast$}{*}filename, const String \&data, bool serialout)
\begin{DoxyCompactList}\small\item\em Logs data to an SD card file and optionally outputs to the serial monitor. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_a9f9d0ca80f41782edf366170577a124e}{handle\+Data\+Logging}} ()
\begin{DoxyCompactList}\small\item\em Handles the data logging process. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_ae2da94e03570cd696d5e1ef31169b6f3}{go\+To\+Sleep}} ()
\begin{DoxyCompactList}\small\item\em Puts the device into deep sleep mode. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_abe87ef16aaf84b82d35566c519f789ef}{bucket\+\_\+tips}} ()
\begin{DoxyCompactList}\small\item\em counts the number of bucket tips of the rain gauge. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_a416b4746bdf23249a26b1d9149208f85}{bucket\+\_\+tips\+\_\+log}} ()
\begin{DoxyCompactList}\small\item\em counts the number of bucket tips of the rain gauge. \end{DoxyCompactList}\item 
void IRAM\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_addd4b4572dcd9663471534593634caac}{ISR}} ()
\begin{DoxyCompactList}\small\item\em Interrupt Service Routine (ISR) for handling bucket tips. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8cpp_afa49d929ad679cfb2cd516727c5225ef}{check\+\_\+reset\+\_\+timer}} ()
\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
int RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_a3eeb80a02a2c4e1b5c56f3ab29822ba1}{num\+\_\+id}} = 0
\item 
int RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_ae789355b7f9c3fc734ba4f80938780fc}{bucket\+\_\+tips\+\_\+counter}} = 0
\item 
int \mbox{\hyperlink{main_8cpp_af865f24a1d57da1153c934c95951b23d}{bucket\+\_\+tips\+\_\+counter\+\_\+log}} =0
\item 
int RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_ad6d607c9a1b9a6bda0c4bb6a93c6d8ee}{sec\+\_\+to\+\_\+micro}} = 1000000
\item 
int RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_a447f9d5cca0f85dddba722a8efcd33bd}{sleep\+\_\+interval}} = 60
\item 
uint32\+\_\+t RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_a385386cbe6b5277d51f6db21eaeda75e}{rain\+\_\+reset\+\_\+timer}} = 0
\item 
int RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_aa5c6b7a0d6c3514eb8a681701bb71129}{sleep\+\_\+counter}} = 0
\item 
int RTC\+\_\+\+DATA\+\_\+\+ATTR \mbox{\hyperlink{main_8cpp_a0a763f258883ac0326002fe737204cf6}{sleep\+\_\+counter\+\_\+limit}} = 10
\item 
float \mbox{\hyperlink{main_8cpp_a6fffef16ece2fa61dac0bc14befa5648}{temp102}}
\item 
Preferences \mbox{\hyperlink{main_8cpp_a6ea06cf7b8092a0adaf07614d7ece59d}{preferences}}
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\Hypertarget{main_8cpp_abe87ef16aaf84b82d35566c519f789ef}\index{main.cpp@{main.cpp}!bucket\_tips@{bucket\_tips}}
\index{bucket\_tips@{bucket\_tips}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{bucket\_tips()}{bucket\_tips()}}
{\footnotesize\ttfamily \label{main_8cpp_abe87ef16aaf84b82d35566c519f789ef} 
void bucket\+\_\+tips (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



counts the number of bucket tips of the rain gauge. 

this function increments the bucket\+\_\+tips\+\_\+counter variable by 1. \Hypertarget{main_8cpp_a416b4746bdf23249a26b1d9149208f85}\index{main.cpp@{main.cpp}!bucket\_tips\_log@{bucket\_tips\_log}}
\index{bucket\_tips\_log@{bucket\_tips\_log}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{bucket\_tips\_log()}{bucket\_tips\_log()}}
{\footnotesize\ttfamily \label{main_8cpp_a416b4746bdf23249a26b1d9149208f85} 
void bucket\+\_\+tips\+\_\+log (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



counts the number of bucket tips of the rain gauge. 

this function increments the bucket\+\_\+tips\+\_\+counter variable by 1. \Hypertarget{main_8cpp_afa49d929ad679cfb2cd516727c5225ef}\index{main.cpp@{main.cpp}!check\_reset\_timer@{check\_reset\_timer}}
\index{check\_reset\_timer@{check\_reset\_timer}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{check\_reset\_timer()}{check\_reset\_timer()}}
{\footnotesize\ttfamily \label{main_8cpp_afa49d929ad679cfb2cd516727c5225ef} 
void check\+\_\+reset\+\_\+timer (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}

\Hypertarget{main_8cpp_ae2da94e03570cd696d5e1ef31169b6f3}\index{main.cpp@{main.cpp}!goToSleep@{goToSleep}}
\index{goToSleep@{goToSleep}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{goToSleep()}{goToSleep()}}
{\footnotesize\ttfamily \label{main_8cpp_ae2da94e03570cd696d5e1ef31169b6f3} 
void go\+To\+Sleep (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Puts the device into deep sleep mode. 

This function performs the necessary steps to put the device into deep sleep mode. It turns off the Wi-\/\+Fi to save power, stops the Wi-\/\+Fi driver, and starts the deep sleep mode. \Hypertarget{main_8cpp_a9f9d0ca80f41782edf366170577a124e}\index{main.cpp@{main.cpp}!handleDataLogging@{handleDataLogging}}
\index{handleDataLogging@{handleDataLogging}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{handleDataLogging()}{handleDataLogging()}}
{\footnotesize\ttfamily \label{main_8cpp_a9f9d0ca80f41782edf366170577a124e} 
void handle\+Data\+Logging (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Handles the data logging process. 

This function is responsible for logging data when the system wakes up. Retrieves the current date and time from the RTC, formats the date and time, and logs the datam to a specified file.

The logged data includes thetemperatur,the amount of rain, the current date, time, and a numerical identifier. \Hypertarget{main_8cpp_addd4b4572dcd9663471534593634caac}\index{main.cpp@{main.cpp}!ISR@{ISR}}
\index{ISR@{ISR}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{ISR()}{ISR()}}
{\footnotesize\ttfamily \label{main_8cpp_addd4b4572dcd9663471534593634caac} 
void IRAM\+\_\+\+ATTR ISR (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Interrupt Service Routine (ISR) for handling bucket tips. 

This function is marked with IRAM\+\_\+\+ATTR to ensure it is placed in the IRAM (Instruction RAM) for faster execution. It is triggered by an interrupt and calls the \doxylink{main_8cpp_a416b4746bdf23249a26b1d9149208f85}{bucket\+\_\+tips\+\_\+log()} function to log the bucket tips. \Hypertarget{main_8cpp_abef06e3b619f047a7b59887b28b33c6e}\index{main.cpp@{main.cpp}!logData@{logData}}
\index{logData@{logData}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{logData()}{logData()}}
{\footnotesize\ttfamily \label{main_8cpp_abef06e3b619f047a7b59887b28b33c6e} 
void log\+Data (\begin{DoxyParamCaption}\item[{const char \texorpdfstring{$\ast$}{*}}]{filename}{, }\item[{const String \&}]{data}{, }\item[{bool}]{serialout}{}\end{DoxyParamCaption})}



Logs data to an SD card file and optionally outputs to the serial monitor. 


\begin{DoxyParams}{Parameters}
{\em filename} & The name of the file to write to on the SD card. \\
\hline
{\em data} & The data to be written to the file. \\
\hline
{\em serialout} & If true, outputs status messages to the serial monitor. \\
\hline
\end{DoxyParams}
\Hypertarget{main_8cpp_afe461d27b9c48d5921c00d521181f12f}\index{main.cpp@{main.cpp}!loop@{loop}}
\index{loop@{loop}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{loop()}{loop()}}
{\footnotesize\ttfamily \label{main_8cpp_afe461d27b9c48d5921c00d521181f12f} 
void loop (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Main loop function that handles server activity and power management. 

This function continuously checks the status of the server and manages power consumption. If the server is active, it checks for a timeout or a wakeup pin press to stop the server and put the device to sleep. If the server is not active, it puts the device to sleep immediately. \Hypertarget{main_8cpp_a4fc01d736fe50cf5b977f755b675f11d}\index{main.cpp@{main.cpp}!setup@{setup}}
\index{setup@{setup}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{setup()}{setup()}}
{\footnotesize\ttfamily \label{main_8cpp_a4fc01d736fe50cf5b977f755b675f11d} 
void setup (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Setup function for initializing the ESP32 and peripherals. 

This function performs the following tasks\+:
\begin{DoxyItemize}
\item Initializes the I2C communication on specified pins.
\item Disables Bluetooth and Wi\+Fi to save power.
\item Initializes the Serial communication for debugging purposes.
\item Sets the CPU to 80MHz.
\item Configures wakeup sources for deep sleep.
\item Checks the wakeup reason and handles accordingly\+:
\begin{DoxyItemize}
\item If woken up by GPIO pin, checks which pin caused the wakeup and handles sensor or Wi\+Fi server.
\item If woken up by timer, initializes RTC, BME280 sensor, and SD card, then logs data.
\item If initial boot or not a GPIO wakeup, scans I2C devices and initializes RTC and CCS811 sensor.
\end{DoxyItemize}
\item Initializes preferences to store and retrieve data.
\item Logs wakeup reason and other debug information to Serial (to be removed in final version). 
\end{DoxyItemize}\Hypertarget{main_8cpp_a986d1c8378e226e7d3f389c83d94d790}\index{main.cpp@{main.cpp}!vspi@{vspi}}
\index{vspi@{vspi}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{vspi()}{vspi()}}
{\footnotesize\ttfamily \label{main_8cpp_a986d1c8378e226e7d3f389c83d94d790} 
SPIClass vspi (\begin{DoxyParamCaption}\item[{VSPI}]{}{}\end{DoxyParamCaption})}



\doxysubsection{Variable Documentation}
\Hypertarget{main_8cpp_ae789355b7f9c3fc734ba4f80938780fc}\index{main.cpp@{main.cpp}!bucket\_tips\_counter@{bucket\_tips\_counter}}
\index{bucket\_tips\_counter@{bucket\_tips\_counter}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{bucket\_tips\_counter}{bucket\_tips\_counter}}
{\footnotesize\ttfamily \label{main_8cpp_ae789355b7f9c3fc734ba4f80938780fc} 
int RTC\+\_\+\+DATA\+\_\+\+ATTR bucket\+\_\+tips\+\_\+counter = 0}

\Hypertarget{main_8cpp_af865f24a1d57da1153c934c95951b23d}\index{main.cpp@{main.cpp}!bucket\_tips\_counter\_log@{bucket\_tips\_counter\_log}}
\index{bucket\_tips\_counter\_log@{bucket\_tips\_counter\_log}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{bucket\_tips\_counter\_log}{bucket\_tips\_counter\_log}}
{\footnotesize\ttfamily \label{main_8cpp_af865f24a1d57da1153c934c95951b23d} 
int bucket\+\_\+tips\+\_\+counter\+\_\+log =0}

\Hypertarget{main_8cpp_a3eeb80a02a2c4e1b5c56f3ab29822ba1}\index{main.cpp@{main.cpp}!num\_id@{num\_id}}
\index{num\_id@{num\_id}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{num\_id}{num\_id}}
{\footnotesize\ttfamily \label{main_8cpp_a3eeb80a02a2c4e1b5c56f3ab29822ba1} 
int RTC\+\_\+\+DATA\+\_\+\+ATTR num\+\_\+id = 0}

\Hypertarget{main_8cpp_a6ea06cf7b8092a0adaf07614d7ece59d}\index{main.cpp@{main.cpp}!preferences@{preferences}}
\index{preferences@{preferences}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{preferences}{preferences}}
{\footnotesize\ttfamily \label{main_8cpp_a6ea06cf7b8092a0adaf07614d7ece59d} 
Preferences preferences}

\Hypertarget{main_8cpp_a385386cbe6b5277d51f6db21eaeda75e}\index{main.cpp@{main.cpp}!rain\_reset\_timer@{rain\_reset\_timer}}
\index{rain\_reset\_timer@{rain\_reset\_timer}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{rain\_reset\_timer}{rain\_reset\_timer}}
{\footnotesize\ttfamily \label{main_8cpp_a385386cbe6b5277d51f6db21eaeda75e} 
uint32\+\_\+t RTC\+\_\+\+DATA\+\_\+\+ATTR rain\+\_\+reset\+\_\+timer = 0}

\Hypertarget{main_8cpp_ad6d607c9a1b9a6bda0c4bb6a93c6d8ee}\index{main.cpp@{main.cpp}!sec\_to\_micro@{sec\_to\_micro}}
\index{sec\_to\_micro@{sec\_to\_micro}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{sec\_to\_micro}{sec\_to\_micro}}
{\footnotesize\ttfamily \label{main_8cpp_ad6d607c9a1b9a6bda0c4bb6a93c6d8ee} 
int RTC\+\_\+\+DATA\+\_\+\+ATTR sec\+\_\+to\+\_\+micro = 1000000}

\Hypertarget{main_8cpp_aa5c6b7a0d6c3514eb8a681701bb71129}\index{main.cpp@{main.cpp}!sleep\_counter@{sleep\_counter}}
\index{sleep\_counter@{sleep\_counter}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{sleep\_counter}{sleep\_counter}}
{\footnotesize\ttfamily \label{main_8cpp_aa5c6b7a0d6c3514eb8a681701bb71129} 
int RTC\+\_\+\+DATA\+\_\+\+ATTR sleep\+\_\+counter = 0}

\Hypertarget{main_8cpp_a0a763f258883ac0326002fe737204cf6}\index{main.cpp@{main.cpp}!sleep\_counter\_limit@{sleep\_counter\_limit}}
\index{sleep\_counter\_limit@{sleep\_counter\_limit}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{sleep\_counter\_limit}{sleep\_counter\_limit}}
{\footnotesize\ttfamily \label{main_8cpp_a0a763f258883ac0326002fe737204cf6} 
int RTC\+\_\+\+DATA\+\_\+\+ATTR sleep\+\_\+counter\+\_\+limit = 10}

\Hypertarget{main_8cpp_a447f9d5cca0f85dddba722a8efcd33bd}\index{main.cpp@{main.cpp}!sleep\_interval@{sleep\_interval}}
\index{sleep\_interval@{sleep\_interval}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{sleep\_interval}{sleep\_interval}}
{\footnotesize\ttfamily \label{main_8cpp_a447f9d5cca0f85dddba722a8efcd33bd} 
int RTC\+\_\+\+DATA\+\_\+\+ATTR sleep\+\_\+interval = 60}

\Hypertarget{main_8cpp_a6fffef16ece2fa61dac0bc14befa5648}\index{main.cpp@{main.cpp}!temp102@{temp102}}
\index{temp102@{temp102}!main.cpp@{main.cpp}}
\doxysubsubsection{\texorpdfstring{temp102}{temp102}}
{\footnotesize\ttfamily \label{main_8cpp_a6fffef16ece2fa61dac0bc14befa5648} 
float temp102}

